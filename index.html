<html>
<head>
    <script src="lib/Dispatcher.js"></script>
    <script src="lib/microevent.js"></script>
    <script src="src/test.js"></script>
    <script src="http://fb.me/react-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
</head>
<body>
    <div id="main"></div>

    <script type="text/jsx">
        var TodoItem = React.createClass({
            handleInput: function (e) {
                this.setState({text: e.target.value});

                if (e.keyCode === 13) {
                    AppDispatcher.dispatch({
                        eventName: 'update-todo',
                        todo: {
                            id: this.props.data.id,
                            text: e.target.value,
                            complete: this.props.complete
                        }
                    });
                }                
            },

            toggleComplete: function (e) {
                AppDispatcher.dispatch({
                    eventName: 'update-todo',
                    todo: {
                        id: this.props.data.id,
                        text: this.props.data.text,
                        complete: e.target.checked
                    }
                });
            },

            render: function () {
                return (
                    <li key={this.props.data.id}>
                        <input value={this.props.data.text} onChange={this.handleInput} />

                        <input type="checkbox"
                               onChange={this.toggleComplete}
                               checked={this.props.data.complete} />
                    </li>
                );
            }
        });

        var Todo = React.createClass({
            getInitialState: function () {
                return {
                    placeholder: 'Enter Todo...',
                    todos: TodoStore.getAll()
                };
            },

            componentDidMount: function () {
                TodoStore.bind('change', this.todosChanged);
            },

            todosChanged: function () {
                this.setState({ todos: TodoStore.getAll() });
            },

            addTodo: function (e) {
                if (this.state.text) {
                    AppDispatcher.dispatch({
                        eventName: 'new-todo',
                        newTodo: {
                            id: this.state.todos.length,
                            text: this.state.text,
                            complete: false
                        }
                    });
                }
            },

            handleInput: function (e) {
                this.setState({ text: e.target.value });

                if (e.keyCode === 13) {
                    this.addTodo();
                    this.setState({ text: '' });
                }
            },

            render: function () {
                var text = this.state.text

                return (
                    <div>
                        <input onChange={ this.handleInput }
                               onKeyDown={ this.handleInput }
                               value={ text }
                               placeholder={ this.state.placeholder } />

                        <button onClick={ this.addTodo }>New Item</button>

                        <ul>
                            {this.state.todos.map(function (todo) {
                                return <TodoItem key={todo.id} data={todo} />;
                            })}
                        </ul>
                    </div>
                );
            }
        });

        var App = React.createClass({
            render: function () {
                return (
                    <div className="App">
                        <Todo />
                    </div>
                );
            }
        });

        React.render(
            <App />,
            document.getElementById('main')
        );
    </script>
</body>
</html>
